-- Taula de receptes generades
-- 1. TAULA DE RECEPTES (El llibre de cuina de Vacíate)
CREATE TABLE recetas (
  -- ID únic que s'incrementa sol (clau primària)
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  
  -- Timestamps per saber quan es va fer cada cosa
  creado_el TIMESTAMPTZ DEFAULT NOW(),
  borrado_el TIMESTAMPTZ DEFAULT NULL, -- Si té data, la recepta està a la "paperera" (Soft Delete)
  
  -- Contingut de la recepta
  titulo TEXT NOT NULL,
  ingredientes JSONB, -- Guardem una llista: ["2 huevos", "un poco de sal"]
  instrucciones TEXT,
  url_imagen TEXT, -- Enllaç a la foto si l'usuari en puja una
  
  -- Estats de la recepta (Molt important pel teu flux!)
  es_ia BOOLEAN DEFAULT TRUE, -- Diferencia si la va fer GPT-4o o l'usuari a mà
  es_publica BOOLEAN DEFAULT FALSE, -- Si és TRUE, tothom la veu al feed. Si és FALSE, és privada.
  
  -- Relació amb l'usuari (Qui és l'amo?)
  -- Fem servir UUID perquè és el format que usa el sistema d'autenticació de Supabase
  usuario_id UUID REFERENCES auth.users(id) NOT NULL
);

-- 2. TAULA DE PERFILS (Dades extres dels usuaris de Vacíate)
CREATE TABLE perfiles (
  -- L'ID ha de ser el mateix que el de auth.users per estar lligats
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  nombre_usuario TEXT UNIQUE, -- El "Nick" de la web
  url_avatar TEXT, -- Foto de perfil
  biografia TEXT, -- Un petit text de presentació
  actualizado_el TIMESTAMPTZ DEFAULT NOW(),
  desactivado_el TIMESTAMPTZ DEFAULT NULL -- Per si l'usuari vol "tancar" el seu compte
);

-- 3. EL "ROBOT" AUTOMÀTIC (Trigger)
-- Aquesta funció fa que, quan un usuari es registri amb email/pass, 
-- se li creï automàticament la seva fila a la taula 'perfiles'.
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.perfiles (id, nombre_usuario)
  VALUES (new.id, new.raw_user_meta_data->>'username');
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();